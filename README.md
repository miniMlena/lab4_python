# Лабораторная работа 4 (+ ЛР №5 в )
## Вариант: Библиотека

* **Цель:** Создать симуляцию с пользовательсĸими ĸоллеĸциями и псевдослучайной моделью на примере работы с книгами в библиотеке.
* **Библиотеки:** *random*, *re*, *time*, *collections*, *typing*, *pytest*
### Допущения:
- Книги генерируются как случайная комбинация названия, автора, года выпуска и жанра. Списки с возможными значениями для каждого параметра лежат в src/constants, на каждый параметр 5-6 возможных значений. Из-за такой генерации, например, у книг разных авторов могут быть одинаковые названия. Это допущение было сделано для того, чтобы было много книг с одинаковым автором, годом выпуска и т.д. и случайная симуляция была более информативной и интересной. Например, так поиск книг выдает больше значений, есть смысл у операции изменения автора/года книги. (+ такую генерацию одобрил лектор)

### Чему я научилась:
- Работа с классами в Python
- Создание производных классов
- Создание пользовательских коллекций: списковой и словарной
- Работа со случайными симуляциями

## Описание результатов работы
### Классы
Было написано 8 классов (4 базовых + 4 производных):
* класс Book

  Класс, представляющий книгу с параметрами название, автор, год выпуска, жанр и ISBN (уникальный код книги). ISBN вычисляется исходя из метаданных книги и таким образом получается, что у одинаковых книг он будет совпадать, а у разных книг - отличаться.

  Методы класса:
  - \_\_init\_\_() - инициализация книги с названием, автором, годом и жанром
  - calculate_isbn() - статический метод для генерации уникального ISBN на основе метаданных
  - \_\_repr\_\_(), \_\_str\_\_() - строковые представления для отладки и вывода

* класс BookCollection

  Списковая коллекция объектов Book с поддержкой основных операций коллекций. Хранит в том числе одинаковые книги.

  Методы:
  - \_\_getitem\_\_() - получение элемента/среза (возвращает BookCollection для срезов)
  - \_\_iter\_\_(), \_\_len\_\_() - итерация, длина
  - \_\_contains\_\_() - проверка наличия
  - \_\_repr\_\_(), \_\_str\_\_() - отладочное и читаемое представление
  - add() - добавление книги
  - remove() - удаление книги (вызывает ValueError если книги нет)

* класс IndexDict
 
  Базовый класс для индексации книг, наследует от collections.UserDict, использует defaultdict(BookCollection) для хранения, поэтому использует именно наши пользовательские коллекции, а не raw-list. Тут уже хранятся только уникальные книги (в отличие от BookCollection).
  
  Методы:
  - \_\_getitem\_\_() возвращает коллекцию книг (BookCollection) по ключу, в том числе пустой BookCollection для отсутствующих ключей
  - \_\_iter\_\_(), \_\_len\_\_(), \_\_str\_\_() - словарные операции

* классы, производные от IndexDict

  Их 4 штуки, каждый класс реализуетиндексацию по своему параметру:
  
  - ISBNIndexDict - индексация по ISBN
  - AuthorIndexDict - индексация по авторам
  - YearIndexDict - индексация по году публикации
  - GenreIndexDict - индексация по жанру
  
  ISBN у каждой книги уникальный, поэтому в ISBNIndexDict каждому ключу соответствует коллекция, состоящая только из 1 книги, но в остальных индексах каждому ключу может соответствовать коллекция с несколькими книгами.
  
  Методы:
  - Все, что есть у IndexDict (т.к. наследуют)
  - add(book) - добавление книги в индекс с учетом специфики поля
  - remove(book) - удаление книги с очисткой пустых записей

* класс Library

Библиотека, объединяющая коллекцию книг и четыре индекса для быстрого поиска.

Включает в себя:
- book_collection: BookCollection - основная коллекция всех книг
- isbn_index: ISBNIndexDict - индекс по ISBN
- author_index: AuthorIndexDict - индекс по авторам
- year_index: YearIndexDict - индекс по году
- genre_index: GenreIndexDict - индекс по жанру

Основные методы:
- add_book(), remove_book() - добавление/удаление с синхронизацией BookCollection и всех индексов
- find_by_author(), find_by_genre(), find_by_year(), find_by_isbn() - поиск через соответствующие индексы
- \_\_len\_\_(), \_\_iter\_\_(), \_\_str\_\_() - по сути берутся из BookCollection

### Случайная симуляция
Пользователь вводит 2 параметра: количество шагов симуляции и сид для генерации. При вводе одинакового сида, генерируется индентичная последовательность событий.

В начале симуляции генерируется 10 случайных книг, чтобы было, с чем работать в дальнейшем, и этот начальный набор книг выводится в консоль. На каждом шаге симуляции происходит одно из случайных событий:
1) Добавление случайной книги.
2) Удаление случайной книги из тех, что есть в библиотеке сейчас.
3) Поиск по автору, году выпуска или жанру.
4) Изменение автора у случайно выбранной книги, причём новый автор гарантировано отличен от текущего.
5) Изменение года выпуска у случайно выбранной книги, причём новый год гарантировано отличен от текущего.
6) Получение книги по комбинации названия и автора, как будто в библиотеку пришел читатель и спрашивает конкретную книгу. Если такой книги нет, то ничего не произойдет, если подходящая книга есть, то её выдадут читателю и из библиотеки она удалится, а если есть несколько книг с таким названием и автором, но осталаьные параметры у них отличаются, то будет выведено сообщение "Недостаточно сведений".
7) Получение книги по ISBN. Аналогично предыдущему, но т.к. ISBN у каждой книги уникальный, то здесь уже невозможна ситуация с недостаточностью сведений. Так что либо такой книги нет, либо она есть, выдается читателю и удаляется из библиотеки

На кадом шаге выводтся номер шага и лог происходящего события (тип события и результат). В конце симуляции выводится конечный набор книг.

После завершения симуляции, можно вновь ввести количество шагов и сид и посмотреть уже новую симуляцию. Для выхода из программы нужно ввести exit.

## Тесты
С помощью pytest были написаны тесты для всех созданных классов и тесты для случайной симуляции. В теста симуляции используются моки, чтобы сделать поведение предсказуемым и проверить конкретные случаи, а также чтобы убрать текстовые логи и паузы между шагами, делая тесты быстрее и с более чистым выводом.

### Интересные тест-кейсы
Для просмотра некоторых интересных ситуаций можете указать seed из этого списка, рядом подписано, что именно интересного при этом происходит:
- seed=16 - на шаге 3 добавляется такая же книга, какая уже была в библиотеке и в конечном списке можно увидеть, что она все равно отображается и ISBN у одинаковых книг одинаковый.
- seed=177 - на шаге 13 и 18 читатели получили книгу по комбинации названия и автора и видно, что в конечном списке этих книг нет
- seed=44 - на шаге 14 читатель получает книгу по ISBN (Питонидзе Л.Р. - "Сэнсей и Мао Ито", 1982, роман, ISBN: 978-2-46000-757-0), а на шаге 18 - по комбинации названия и автора. В конечном списке книг видно, что их обеих больше нет в библиотеке.
- seed=33 - на шаге 16 читатель пытается получить книгу по комбинации названия и автора, но есть 2 подходящих книги (название и автор одинаковые, а что-то другое отличается) и можно увидеть сообщение "Недостаточно сведений". В конечном списке книг видно, что обе книги остались в коллекции.
- В тестах рассматривается ситуация, когда библиотека пуста, и в этом случае всегда происходит добавление книги.

Остальные события (поиск, изменение индекса, добавление, удаление и попытка получить книгу, которой нет в библиотеке) и так очень часто происходят и их можно увидеть в любой симуляции, поэтому тут они не описаны.

## Инструкция по использованию

### Установка
```pip install -e git+https://github.com/miniMlena/lab4_python#egg=labs```\
```cd src/labs```
или:
```git clone https://github.com/miniMlena/lab4_python```
```cd lab4_python```

### Запуск
Запуск самой программы:
```python -m src.main```

Запуск тестов:
```pytest```

### Синтаксис
* Можно ввести 2 параметра: steps количество шагов симуляции и seed - сид для генерации. Формат ввода: steps=n seed=m
* Можно ввести оба параметра, можно только один из них, а можно не вводить ничего
* Если вводится оба параметра, они должны быть именно в таком поярдке: снчала steps, затем seed
* Если какой-то из параметров не введен, используется значение по умолчанию. Для steps это 20, а для seed - None
* Примеры:
steps=10 seed=42     - 10 шагов симуляции с сидом 42
steps=10             - 10 шагов симуляции без использования сида
seed=33              - 20 шагов симуляции с сидом 33
                     - 20 шагов симуляции без сида
* Для выхода из программы нужно ввести exit
